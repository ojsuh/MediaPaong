<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I. New - Platform Berkas</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel for component-based UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-primary: #58a6ff;
            --accent-hover: #1f6feb;
            --danger-color: #f85149;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: 1px solid var(--border-color);
        }
        .btn-primary {
            background-color: #238636;
            border-color: rgba(240, 246, 252, 0.1);
            color: white;
        }
        .btn-primary:hover { background-color: #2ea043; }
        .btn-secondary {
            background-color: #21262d;
        }
        .btn-secondary:hover { background-color: #30363d; }
        .input-field {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            color: var(--text-primary);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
        }
        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-toggle-btn {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .spinner {
            animation: spin 1s linear infinite;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ========================================================================
        // SUPABASE CLIENT SETUP
        // ========================================================================
        const SUPABASE_URL = 'https://phkyhpgfafyaifqfttsb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoa3locGdmYWZ5YWlmcWZ0dHNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjI0NzQsImV4cCI6MjA2OTE5ODQ3NH0.1koIZHyefLr5dJ_LxA2ZI4Q8KeWml4RCtrlnMesFie4';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========================================================================
        // ICON COMPONENTS
        // ========================================================================
        const Icon = ({ name, size = 16 }) => {
            const icons = {
                upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" />,
                user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
                dashboard: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></>,
                logout: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></>,
                copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></>,
                trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
                visibility: <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></>,
                visibility_off: <><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 0 0-4.24-4.24" /><path d="M1 12s4-8 11-8 11 8 11 8M1 1l22 22" /></>,
                agent: <><path d="M12 8V4H8" /><rect x="4" y="12" width="8" height="8" rx="2" /><path d="M20 12v8" /><path d="M18 12h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2v0a2 2 0 0 0 2-2V8.5a2.5 2.5 0 0 0-5 0V12" /></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    {icons[name]}
                </svg>
            );
        };

        // ========================================================================
        // AUTHENTICATION & PASSWORD RESET
        // ========================================================================
        function AuthPage() {
            // ... (No changes from previous version) ...
            const [mode, setMode] = React.useState('login');
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [username, setUsername] = React.useState('');
            const [showPassword, setShowPassword] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState({ type: '', text: '' });

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage({ type: '', text: '' });

                try {
                    if (mode === 'login') {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else if (mode === 'register') {
                        const { error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: { data: { username: username, avatar_url: `https://placehold.co/128x128/0d1117/c9d1d9?text=${username.charAt(0).toUpperCase()}` } }
                        });
                        if (error) throw error;
                        setMessage({ type: 'success', text: 'Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi.' });
                    } else if (mode === 'reset_request') {
                        const { error } = await supabase.auth.resetPasswordForEmail(email, {
                            redirectTo: window.location.origin,
                        });
                        if (error) throw error;
                        setMessage({ type: 'success', text: 'Link reset sandi telah dikirim ke email Anda.' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: error.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const PasswordInput = ({ value, onChange }) => (
                <div className="password-input-wrapper">
                    <input type={showPassword ? 'text' : 'password'} value={value} onChange={onChange} className="input-field pr-10" required />
                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="password-toggle-btn">
                        <Icon name={showPassword ? 'visibility_off' : 'visibility'} />
                    </button>
                </div>
            );

            if (mode === 'login') {
                return (
                    <div className="w-full max-w-md p-8 space-y-6 card">
                        <div className="text-center">
                            <h1 className="text-3xl font-bold text-white">P.I. NEW</h1>
                            <p className="text-gray-400">Selamat datang kembali</p>
                        </div>
                        {message.text && <div className={`p-3 rounded-md text-center ${message.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>{message.text}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="text-sm font-medium text-gray-400">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field mt-1" required /></div>
                            <div><label className="text-sm font-medium text-gray-400">Password</label><PasswordInput value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            <div className="text-right"><a href="#" onClick={(e) => { e.preventDefault(); setMode('reset_request'); }} className="text-sm text-blue-400 hover:underline">Lupa Sandi?</a></div>
                            <button type="submit" disabled={loading} className="w-full btn btn-primary justify-center">{loading ? 'Memproses...' : 'Login'}</button>
                        </form>
                        <p className="text-center text-sm text-gray-400">Belum punya akun? <a href="#" onClick={(e) => { e.preventDefault(); setMode('register'); }} className="font-medium text-blue-400 hover:underline ml-1">Daftar</a></p>
                    </div>
                );
            }

            if (mode === 'register') {
                 return (
                    <div className="w-full max-w-md p-8 space-y-6 card">
                        <div className="text-center"><h1 className="text-3xl font-bold text-white">Buat Akun Baru</h1></div>
                        {message.text && <div className={`p-3 rounded-md text-center ${message.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>{message.text}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                             <div><label className="text-sm font-medium text-gray-400">Username</label><input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="input-field mt-1" required /></div>
                            <div><label className="text-sm font-medium text-gray-400">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field mt-1" required /></div>
                            <div><label className="text-sm font-medium text-gray-400">Password</label><PasswordInput value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            <button type="submit" disabled={loading} className="w-full btn btn-primary justify-center">{loading ? 'Memproses...' : 'Daftar'}</button>
                        </form>
                        <p className="text-center text-sm text-gray-400">Sudah punya akun? <a href="#" onClick={(e) => { e.preventDefault(); setMode('login'); }} className="font-medium text-blue-400 hover:underline ml-1">Login</a></p>
                    </div>
                );
            }

            if (mode === 'reset_request') {
                return (
                    <div className="w-full max-w-md p-8 space-y-6 card">
                        <div className="text-center"><h1 className="text-3xl font-bold text-white">Reset Sandi</h1><p className="text-gray-400 mt-2">Masukkan email Anda untuk menerima link reset.</p></div>
                        {message.text && <div className={`p-3 rounded-md text-center ${message.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>{message.text}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="text-sm font-medium text-gray-400">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field mt-1" required /></div>
                            <button type="submit" disabled={loading} className="w-full btn btn-primary justify-center">{loading ? 'Mengirim...' : 'Kirim Link Reset'}</button>
                        </form>
                        <p className="text-center text-sm text-gray-400"><a href="#" onClick={(e) => { e.preventDefault(); setMode('login'); }} className="font-medium text-blue-400 hover:underline ml-1">Kembali ke Login</a></p>
                    </div>
                );
            }
        }
        
        function UpdatePasswordPage() {
            // ... (No changes from previous version) ...
            const [password, setPassword] = React.useState('');
            const [showPassword, setShowPassword] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState({ type: '', text: '' });

            const handlePasswordUpdate = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage({ type: '', text: '' });
                const { error } = await supabase.auth.updateUser({ password: password });
                if (error) {
                    setMessage({ type: 'error', text: error.message });
                } else {
                    setMessage({ type: 'success', text: 'Sandi berhasil diperbarui! Anda akan diarahkan...' });
                }
                setLoading(false);
            };

            const PasswordInput = ({ value, onChange }) => (
                <div className="password-input-wrapper">
                    <input type={showPassword ? 'text' : 'password'} value={value} onChange={onChange} className="input-field pr-10" required />
                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="password-toggle-btn">
                        <Icon name={showPassword ? 'visibility_off' : 'visibility'} />
                    </button>
                </div>
            );

            return (
                 <div className="min-h-screen flex items-center justify-center bg-gray-900/50">
                    <div className="w-full max-w-md p-8 space-y-6 card">
                        <div className="text-center"><h1 className="text-3xl font-bold text-white">Ganti Sandi Baru</h1></div>
                        {message.text && <div className={`p-3 rounded-md text-center ${message.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>{message.text}</div>}
                        <form onSubmit={handlePasswordUpdate} className="space-y-4">
                            <div><label className="text-sm font-medium text-gray-400">Password Baru</label><PasswordInput value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            <button type="submit" disabled={loading} className="w-full btn btn-primary justify-center">{loading ? 'Menyimpan...' : 'Simpan Sandi Baru'}</button>
                        </form>
                    </div>
                </div>
            )
        }

        // ========================================================================
        // MAIN APPLICATION COMPONENTS
        // ========================================================================
        
        function Sidebar({ setPage, session, profile }) {
            const handleLogout = async () => {
                await supabase.auth.signOut();
            };

            return (
                <aside className="w-64 bg-bg-primary border-r border-border-color p-4 flex flex-col">
                    <div className="mb-8 flex items-center gap-3">
                        <img src={profile?.avatar_url} alt="Avatar" className="w-10 h-10 rounded-full bg-gray-700" />
                        <div>
                            <h1 className="text-md font-bold text-white">{profile?.username || 'Pengguna'}</h1>
                            <p className="text-xs text-text-secondary">{session.user.email}</p>
                        </div>
                    </div>
                    <nav className="flex-grow space-y-2">
                        <button onClick={() => setPage('dashboard')} className="w-full btn btn-secondary justify-start"><Icon name="dashboard" /> Dasbor</button>
                        <button onClick={() => setPage('profile')} className="w-full btn btn-secondary justify-start"><Icon name="user" /> Profil</button>
                        <button onClick={() => setPage('agent')} className="w-full btn btn-secondary justify-start"><Icon name="agent" /> AI Agent</button>
                    </nav>
                    <button onClick={handleLogout} className="w-full btn btn-secondary justify-start mt-4"><Icon name="logout" /> Logout</button>
                </aside>
            );
        }

        function DashboardPage({ setPage, session }) {
            const [files, setFiles] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                fetchFiles();
            }, []);

            const fetchFiles = async () => {
                setLoading(true);
                const { data, error } = await supabase
                    .from('files')
                    .select('*')
                    .eq('owner_id', session.user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error fetching files:', error);
                } else {
                    setFiles(data);
                }
                setLoading(false);
            };

            const handleDelete = async (fileId, filePath) => {
                if (confirm('Apakah Anda yakin ingin menghapus file ini?')) {
                    const { error: storageError } = await supabase.storage.from('uploads').remove([filePath]);
                    if (storageError) {
                        alert('Gagal menghapus file dari storage: ' + storageError.message);
                        return;
                    }
                    const { error: dbError } = await supabase.from('files').delete().eq('id', fileId);
                    if (dbError) {
                        alert('Gagal menghapus data file: ' + dbError.message);
                    } else {
                        fetchFiles();
                    }
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Link disalin ke clipboard!');
                }, () => {
                    alert('Gagal menyalin link.');
                });
            };

            return (
                <div className="p-8 w-full">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-white">Berkas Anda</h2>
                        <button onClick={() => setPage('upload')} className="btn btn-primary"><Icon name="upload" /> Unggah Berkas</button>
                    </div>
                    <div className="card p-4">
                        {loading ? <p>Memuat berkas...</p> : (
                            files.length === 0 ? <p className="text-text-secondary text-center py-8">Anda belum mengunggah berkas apapun.</p> : (
                                <ul className="space-y-3">
                                    {files.map(file => (
                                        <li key={file.id} className="flex items-center justify-between p-3 bg-bg-primary rounded-md">
                                            <div>
                                                <p className="font-semibold">{file.file_name}</p>
                                                <p className="text-sm text-text-secondary">{(file.file_size / 1024 / 1024).toFixed(2)} MB</p>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <a href={file.public_url} target="_blank" rel="noopener noreferrer" className="btn btn-secondary p-2" title="Unduh">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                </a>
                                                <button onClick={() => copyToClipboard(file.public_url)} className="btn btn-secondary p-2" title="Salin Link Publik"><Icon name="copy" /></button>
                                                <button onClick={() => handleDelete(file.id, file.file_path)} className="btn btn-secondary p-2 text-danger-color" title="Hapus"><Icon name="trash" /></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )
                        )}
                    </div>
                </div>
            );
        }

        function UploadPage({ setPage, session }) {
            const [file, setFile] = React.useState(null);
            const [uploading, setUploading] = React.useState(false);
            const [message, setMessage] = React.useState('');

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    setFile(e.target.files[0]);
                }
            };

            const handleUpload = async () => {
                if (!file) {
                    setMessage('Pilih file terlebih dahulu.');
                    return;
                }
                setUploading(true);
                setMessage('Mengunggah...');
                
                // Generate a random UUID for the file to ensure unique URL
                const fileId = crypto.randomUUID();
                const fileExt = file.name.split('.').pop();
                const filePath = `${session.user.id}/${fileId}.${fileExt}`;

                const { error: uploadError } = await supabase.storage.from('uploads').upload(filePath, file);
                if (uploadError) {
                    setMessage('Error: ' + uploadError.message);
                    setUploading(false);
                    return;
                }

                const { data: urlData } = supabase.storage.from('uploads').getPublicUrl(filePath);
                
                const { error: dbError } = await supabase.from('files').insert({
                    id: fileId, // Use the generated UUID as the primary key
                    owner_id: session.user.id,
                    file_name: file.name,
                    file_path: filePath,
                    file_size: file.size,
                    public_url: urlData.publicUrl,
                });
                if (dbError) {
                    setMessage('Error menyimpan data: ' + dbError.message);
                    setUploading(false);
                    return;
                }
                setMessage('Unggah berhasil!');
                setTimeout(() => setPage('dashboard'), 1500);
            };

            return (
                <div className="p-8 w-full">
                    <h2 className="text-2xl font-bold text-white mb-6">Unggah Berkas Baru</h2>
                    <div className="card p-8 max-w-lg mx-auto">
                        <div className="space-y-4">
                            <label className="block text-sm font-medium text-gray-400">Pilih File (APK, Gambar, dll.)</label>
                            <input type="file" onChange={handleFileChange} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-bg-primary file:text-text-primary hover:file:bg-border-color" />
                            {file && <p className="text-sm text-text-secondary">File dipilih: {file.name}</p>}
                            <button onClick={handleUpload} disabled={uploading} className="w-full btn btn-primary justify-center">
                                {uploading ? 'Sedang Mengunggah...' : 'Unggah Sekarang'}
                            </button>
                            {message && <p className="text-center text-sm mt-4">{message}</p>}
                        </div>
                        <button onClick={() => setPage('dashboard')} className="mt-6 text-sm text-blue-400 hover:underline">Kembali ke Dasbor</button>
                    </div>
                </div>
            );
        }

        function ProfilePage({ setPage, session }) {
            // ... (No changes from previous version) ...
            const [profile, setProfile] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [uploading, setUploading] = React.useState(false);
            const fileInputRef = React.useRef();

            React.useEffect(() => {
                fetchProfile();
            }, []);

            const fetchProfile = async () => {
                setLoading(true);
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                if (error) {
                    console.error('Error fetching profile:', error);
                } else {
                    setProfile(data);
                }
                setLoading(false);
            };

            const handleAvatarUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setUploading(true);
                const filePath = `avatars/${session.user.id}/${Date.now()}`;
                
                const { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file);
                if (uploadError) {
                    alert('Gagal mengunggah avatar: ' + uploadError.message);
                    setUploading(false);
                    return;
                }

                const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);
                const publicUrl = urlData.publicUrl;

                const { error: dbError } = await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', session.user.id);
                if (dbError) {
                    alert('Gagal memperbarui profil: ' + dbError.message);
                } else {
                    setProfile(prev => ({ ...prev, avatar_url: publicUrl }));
                }
                setUploading(false);
            };
            
            if (loading) return <div className="p-8">Memuat profil...</div>;

            return (
                 <div className="p-8 w-full">
                    <h2 className="text-2xl font-bold text-white mb-6">Profil Pengguna</h2>
                    <div className="card p-8 max-w-lg mx-auto space-y-6">
                        <div className="flex flex-col items-center space-y-4">
                            <img 
                                src={profile?.avatar_url || `https://placehold.co/128x128/0d1117/c9d1d9?text=${profile?.username?.charAt(0).toUpperCase() || 'P'}`} 
                                alt="Avatar" 
                                className="w-32 h-32 rounded-full bg-gray-700 object-cover" 
                            />
                            <input type="file" ref={fileInputRef} onChange={handleAvatarUpload} accept="image/*" style={{ display: 'none' }} />
                            <button onClick={() => fileInputRef.current.click()} disabled={uploading} className="btn btn-secondary">
                                {uploading ? "Mengunggah..." : "Ubah Foto"}
                            </button>
                        </div>
                        <div>
                            <label className="text-sm font-medium text-gray-400">Username</label>
                            <input type="text" defaultValue={profile?.username} className="input-field mt-1" disabled />
                        </div>
                         <div>
                            <label className="text-sm font-medium text-gray-400">Email</label>
                            <input type="email" value={session.user.email} className="input-field mt-1" disabled />
                        </div>
                        <p className="text-sm text-text-secondary text-center">Fitur untuk mengubah username dan info lain akan segera hadir.</p>
                        <button onClick={() => setPage('dashboard')} className="w-full btn btn-secondary justify-center">Kembali ke Dasbor</button>
                    </div>
                </div>
            );
        }

        // --- NEW: AI Agent Page ---
        function AIAgentPage({ session }) {
            const userKey = `AIzaSyBIXKwrs0BaybchqgFko79ezDbre2IYpyM`{session.user.id}`;
            const [apiKey, setApiKey] = React.useState(() => localStorage.getItem(userKey) || '');
            const [tempApiKey, setTempApiKey] = React.useState('');
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const systemPrompt = `Anda adalah AI Agent dari Perusahaan Paong Internasional C.P. NEW. Anda adalah asisten yang cerdas, membantu, dan informatif. Berikan jawaban yang relevan dan profesional. Ingat, Anda mewakili perusahaan.`;

            const handleSaveKey = () => {
                localStorage.setItem(userKey, tempApiKey);
                setApiKey(tempApiKey);
            };

            const handleSendMessage = async () => {
                if (!input.trim() || loading) return;
                const newMessages = [...messages, { role: 'user', parts: [{ text: input }] }];
                setMessages(newMessages);
                setInput('');
                setLoading(true);

                // Keep only the last 5 user/model pairs (10 messages) for context
                const history = newMessages.slice(-10); 
                const payload = {
                    contents: [
                        { role: 'user', parts: [{ text: systemPrompt }] },
                        { role: 'model', parts: [{ text: 'Baik, saya mengerti. Saya adalah AI Agent dari Perusahaan Paong Internasional C.P. NEW.' }] },
                        ...history
                    ]
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || 'Gagal menghubungi API Gemini.');
                    }
                    const data = await response.json();
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    setMessages(prev => [...prev, { role: 'model', parts: [{ text: aiResponse }] }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'model', parts: [{ text: `Error: ${error.message}` }] }]);
                } finally {
                    setLoading(false);
                }
            };

            if (!apiKey) {
                return (
                    <div className="p-8 w-full flex items-center justify-center">
                        <div className="card p-8 max-w-lg w-full space-y-4">
                            <h2 className="text-xl font-bold text-white">Konfigurasi AI Agent</h2>
                            <p className="text-text-secondary">Untuk menggunakan fitur ini, silakan masukkan Gemini API Key Anda. Kunci Anda disimpan dengan aman di perangkat ini.</p>
                            <div>
                                <label className="text-sm font-medium text-gray-400">Gemini API Key</label>
                                <input type="password" value={tempApiKey} onChange={(e) => setTempApiKey(e.target.value)} className="input-field mt-1" />
                            </div>
                            <button onClick={handleSaveKey} className="btn btn-primary w-full justify-center">Simpan Kunci API</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-8 w-full flex flex-col h-full">
                    <h2 className="text-2xl font-bold text-white mb-4">AI Agent</h2>
                    <div className="flex-grow card p-4 flex flex-col space-y-4 overflow-y-auto">
                        {messages.map((msg, index) => (
                            <div key={index} className={`p-3 rounded-lg max-w-xl ${msg.role === 'user' ? 'bg-blue-900/50 self-end' : 'bg-gray-700/50 self-start'}`}>
                                <p style={{ whiteSpace: 'pre-wrap' }}>{msg.parts[0].text}</p>
                            </div>
                        ))}
                        {loading && <div className="self-start"><div className="spinner"></div></div>}
                    </div>
                    <div className="mt-4 flex gap-4">
                        <input 
                            type="text" 
                            value={input} 
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                            placeholder="Tanyakan sesuatu pada AI Agent..." 
                            className="input-field flex-grow"
                            disabled={loading}
                        />
                        <button onClick={handleSendMessage} disabled={loading} className="btn btn-primary">{loading ? '...' : 'Kirim'}</button>
                    </div>
                </div>
            );
        }

        // ========================================================================
        // MAIN APP COMPONENT
        // ========================================================================
        function App() {
            const [session, setSession] = React.useState(null);
            const [profile, setProfile] = React.useState(null);
            const [authMode, setAuthMode] = React.useState('login');
            const [page, setPage] = React.useState('dashboard');

            React.useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchProfile(session.user.id);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    if (_event === 'PASSWORD_RECOVERY') {
                        setAuthMode('update_password');
                    } else if (_event === 'SIGNED_IN') {
                         setAuthMode('login');
                         fetchProfile(session.user.id);
                    } else {
                        setAuthMode('login');
                        setProfile(null); // Clear profile on logout
                    }
                    setSession(session);
                });

                return () => subscription.unsubscribe();
            }, []);
            
            const fetchProfile = async (userId) => {
                 const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                if (data) setProfile(data);
            };

            if (!session) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        {authMode === 'update_password' ? <UpdatePasswordPage /> : <AuthPage />}
                    </div>
                );
            }

            const renderPage = () => {
                switch (page) {
                    case 'profile':
                        return <ProfilePage setPage={setPage} session={session} />;
                    case 'upload':
                        return <UploadPage setPage={setPage} session={session} />;
                    case 'agent':
                        return <AIAgentPage session={session} />;
                    case 'dashboard':
                    default:
                        return <DashboardPage setPage={setPage} session={session} />;
                }
            };

            return (
                <div className="flex h-screen">
                    <Sidebar setPage={setPage} session={session} profile={profile} />
                    <main className="flex-1 overflow-y-auto">
                        {renderPage()}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
